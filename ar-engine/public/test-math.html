<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Math - Hello World Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            color: #00ff88;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        h2 {
            color: #00aaff;
            margin: 20px 0 10px 0;
            font-size: 18px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.loading {
            background: #333;
            border: 2px solid #666;
        }
        .status.success {
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid #00ff88;
            color: #00ff88;
        }
        .status.error {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            color: #ff4444;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .test-result {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success-text { color: #00ff88; }
        .error-text { color: #ff4444; }
        .info-text { color: #00aaff; }
        .number-text { color: #ffaa00; }
        button {
            background: linear-gradient(135deg, #00ff88, #00aa44);
            border: none;
            color: #000;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.95);
        }
        .matrix-display {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            max-width: 400px;
            margin: 10px 0;
        }
        .matrix-cell {
            background: #222;
            padding: 8px;
            text-align: center;
            border-radius: 4px;
            font-size: 12px;
            color: #ffaa00;
        }
        #three-canvas {
            width: 100%;
            height: 300px;
            border: 2px solid #333;
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AR Math WebAssembly Test</h1>

        <div id="status" class="status loading">
            WebAssembly 모듈 로딩 중...
        </div>

        <!-- Hello World 테스트 -->
        <div class="test-section">
            <h2>1. Hello World</h2>
            <button onclick="testHelloWorld()">테스트 실행</button>
            <div id="hello-result" class="test-result">-</div>
        </div>

        <!-- 벡터 연산 테스트 -->
        <div class="test-section">
            <h2>2. Vector3 연산</h2>
            <button onclick="testVec3()">벡터 연산 테스트</button>
            <div id="vec3-result" class="test-result">-</div>
        </div>

        <!-- 행렬 연산 테스트 -->
        <div class="test-section">
            <h2>3. Matrix4 연산</h2>
            <button onclick="testMat4()">행렬 연산 테스트</button>
            <div id="mat4-result" class="test-result">-</div>
            <div id="matrix-display" class="matrix-display"></div>
        </div>

        <!-- MVP 행렬 테스트 -->
        <div class="test-section">
            <h2>4. MVP 행렬 (View-Projection)</h2>
            <button onclick="testMVP()">MVP 테스트</button>
            <div id="mvp-result" class="test-result">-</div>
        </div>

        <!-- Three.js 연동 테스트 -->
        <div class="test-section">
            <h2>5. Three.js 연동 테스트</h2>
            <button onclick="testThreeIntegration()">Three.js 연동 테스트</button>
            <div id="three-result" class="test-result">-</div>
            <canvas id="three-canvas"></canvas>
        </div>

        <!-- 성능 테스트 -->
        <div class="test-section">
            <h2>6. 성능 테스트</h2>
            <button onclick="testPerformance()">1000회 행렬 곱셈 벤치마크</button>
            <div id="perf-result" class="test-result">-</div>
        </div>
    </div>

    <!-- Three.js 로드 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Wasm 모듈 로드 -->
    <script src="/wasm/ar-math.js"></script>

    <script>
        let wasmModule = null;

        // 모듈 초기화
        async function initModule() {
            const statusEl = document.getElementById('status');
            try {
                wasmModule = await createARMathModule();
                statusEl.className = 'status success';
                statusEl.textContent = '✓ WebAssembly 모듈 로드 완료! ' + wasmModule.helloWorld();
                console.log('Wasm module initialized:', wasmModule);
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '✗ 모듈 로드 실패: ' + error.message;
                console.error('Init error:', error);
            }
        }

        // 1. Hello World 테스트
        function testHelloWorld() {
            const resultEl = document.getElementById('hello-result');
            try {
                const message = wasmModule.helloWorld();
                resultEl.innerHTML = `<span class="success-text">✓ ${message}</span>`;
            } catch (e) {
                resultEl.innerHTML = `<span class="error-text">✗ Error: ${e.message}</span>`;
            }
        }

        // 2. Vec3 테스트
        function testVec3() {
            const resultEl = document.getElementById('vec3-result');
            try {
                // 두 벡터 생성
                const v1 = wasmModule.vec3_create(1, 2, 3);
                const v2 = wasmModule.vec3_create(4, 5, 6);

                // C++ 테스트 함수 호출
                const result = wasmModule.testVectorOperations([1, 2, 3], [4, 5, 6]);

                let output = '';
                output += `<span class="info-text">v1 = (1, 2, 3)</span>\n`;
                output += `<span class="info-text">v2 = (4, 5, 6)</span>\n\n`;
                output += `<span class="success-text">내적 (dot):</span> <span class="number-text">${result.dot}</span>\n`;
                output += `<span class="success-text">외적 (cross):</span> <span class="number-text">[${result.cross.join(', ')}]</span>\n`;
                output += `<span class="success-text">v1 길이:</span> <span class="number-text">${result.v1Length.toFixed(4)}</span>\n`;
                output += `<span class="success-text">v2 길이:</span> <span class="number-text">${result.v2Length.toFixed(4)}</span>\n`;
                output += `<span class="success-text">v1 + v2:</span> <span class="number-text">[${result.sum.join(', ')}]</span>`;

                resultEl.innerHTML = output;
            } catch (e) {
                resultEl.innerHTML = `<span class="error-text">✗ Error: ${e.message}</span>`;
            }
        }

        // 3. Mat4 테스트
        function testMat4() {
            const resultEl = document.getElementById('mat4-result');
            const matrixDisplay = document.getElementById('matrix-display');
            try {
                // 이동(1,2,3) + Y축 회전(45도) 테스트
                const angle = Math.PI / 4; // 45도
                const result = wasmModule.testMatrixOperations(1, 2, 3, angle);

                let output = '';
                output += `<span class="info-text">이동: (1, 2, 3), Y축 회전: 45°</span>\n\n`;
                output += `<span class="success-text">변환된 원점:</span> <span class="number-text">[${result.transformedPoint.map(v => v.toFixed(4)).join(', ')}]</span>\n\n`;
                output += `<span class="success-text">Model 행렬 (4x4):</span>`;

                resultEl.innerHTML = output;

                // 행렬 시각화
                matrixDisplay.innerHTML = '';
                const matrix = result.modelMatrix;
                for (let i = 0; i < 16; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell';
                    cell.textContent = matrix[i].toFixed(3);
                    matrixDisplay.appendChild(cell);
                }
            } catch (e) {
                resultEl.innerHTML = `<span class="error-text">✗ Error: ${e.message}</span>`;
                matrixDisplay.innerHTML = '';
            }
        }

        // 4. MVP 테스트
        function testMVP() {
            const resultEl = document.getElementById('mvp-result');
            try {
                // 카메라 설정
                const eye = [0, 2, 5];
                const target = [0, 0, 0];
                const fovY = Math.PI / 4; // 45도
                const aspect = 16 / 9;
                const near = 0.1;
                const far = 100;

                const result = wasmModule.createMVPMatrix(
                    eye[0], eye[1], eye[2],
                    target[0], target[1], target[2],
                    fovY, aspect, near, far
                );

                let output = '';
                output += `<span class="info-text">카메라 위치: [${eye.join(', ')}]</span>\n`;
                output += `<span class="info-text">타겟: [${target.join(', ')}]</span>\n`;
                output += `<span class="info-text">FOV: 45°, Aspect: 16:9, Near: 0.1, Far: 100</span>\n\n`;

                output += `<span class="success-text">View 행렬 (첫 4개):</span>\n`;
                output += `<span class="number-text">[${result.viewMatrix.slice(0, 4).map(v => v.toFixed(4)).join(', ')}...]</span>\n\n`;

                output += `<span class="success-text">Projection 행렬 (첫 4개):</span>\n`;
                output += `<span class="number-text">[${result.projectionMatrix.slice(0, 4).map(v => v.toFixed(4)).join(', ')}...]</span>`;

                resultEl.innerHTML = output;
            } catch (e) {
                resultEl.innerHTML = `<span class="error-text">✗ Error: ${e.message}</span>`;
            }
        }

        // 5. Three.js 연동 테스트
        function testThreeIntegration() {
            const resultEl = document.getElementById('three-result');
            const canvas = document.getElementById('three-canvas');

            try {
                // Three.js 씬 설정
                const scene = new THREE.Scene();
                const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                renderer.setClearColor(0x1a1a2e);

                // C++에서 MVP 행렬 계산
                const eye = [3, 3, 5];
                const target = [0, 0, 0];
                const fovY = Math.PI / 4;
                const aspect = canvas.clientWidth / canvas.clientHeight;

                const mvpResult = wasmModule.createMVPMatrix(
                    eye[0], eye[1], eye[2],
                    target[0], target[1], target[2],
                    fovY, aspect, 0.1, 100
                );

                // Three.js 카메라에 C++ 행렬 적용
                const camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 100);
                camera.position.set(eye[0], eye[1], eye[2]);
                camera.lookAt(target[0], target[1], target[2]);

                // 큐브 추가
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshBasicMaterial({
                    color: 0x00ff88,
                    wireframe: true
                });
                const cube = new THREE.Mesh(geometry, material);
                scene.add(cube);

                // 축 헬퍼
                const axesHelper = new THREE.AxesHelper(2);
                scene.add(axesHelper);

                // C++에서 회전 행렬 계산
                const angle = Date.now() * 0.001;
                const rotResult = wasmModule.testMatrixOperations(0, 0, 0, angle);

                // Three.js Matrix4에 C++ 행렬 적용
                const rotMatrix = new THREE.Matrix4();
                rotMatrix.fromArray(rotResult.modelMatrix);
                cube.matrix.copy(rotMatrix);
                cube.matrixAutoUpdate = false;

                // 렌더링
                renderer.render(scene, camera);

                // 애니메이션
                function animate() {
                    const t = Date.now() * 0.001;
                    const rotRes = wasmModule.testMatrixOperations(0, 0, 0, t);
                    const mat = new THREE.Matrix4();
                    mat.fromArray(rotRes.modelMatrix);
                    cube.matrix.copy(mat);
                    renderer.render(scene, camera);
                    requestAnimationFrame(animate);
                }
                animate();

                let output = '';
                output += `<span class="success-text">✓ Three.js 연동 성공!</span>\n`;
                output += `<span class="info-text">C++ 행렬 → Three.js Matrix4 변환 완료</span>\n`;
                output += `<span class="info-text">큐브가 C++에서 계산된 회전 행렬로 회전 중...</span>`;

                resultEl.innerHTML = output;
            } catch (e) {
                resultEl.innerHTML = `<span class="error-text">✗ Error: ${e.message}</span>`;
            }
        }

        // 6. 성능 테스트
        function testPerformance() {
            const resultEl = document.getElementById('perf-result');
            try {
                const iterations = 1000;

                // C++ 행렬 곱셈 벤치마크
                const startWasm = performance.now();
                let mat = wasmModule.mat4_identity();
                const rot = wasmModule.mat4_rotationY(0.01);
                for (let i = 0; i < iterations; i++) {
                    mat = wasmModule.mat4_multiply(mat, rot);
                }
                const endWasm = performance.now();
                const wasmTime = endWasm - startWasm;

                // JavaScript 행렬 곱셈 벤치마크 (비교용)
                const startJS = performance.now();
                let jsMat = new Float32Array([
                    1, 0, 0, 0,
                    0, 1, 0, 0,
                    0, 0, 1, 0,
                    0, 0, 0, 1
                ]);
                const c = Math.cos(0.01);
                const s = Math.sin(0.01);
                const jsRot = new Float32Array([
                    c, 0, s, 0,
                    0, 1, 0, 0,
                    -s, 0, c, 0,
                    0, 0, 0, 1
                ]);
                for (let i = 0; i < iterations; i++) {
                    const result = new Float32Array(16);
                    for (let col = 0; col < 4; col++) {
                        for (let row = 0; row < 4; row++) {
                            for (let k = 0; k < 4; k++) {
                                result[col * 4 + row] += jsMat[k * 4 + row] * jsRot[col * 4 + k];
                            }
                        }
                    }
                    jsMat = result;
                }
                const endJS = performance.now();
                const jsTime = endJS - startJS;

                let output = '';
                output += `<span class="info-text">${iterations}회 행렬 곱셈 벤치마크</span>\n\n`;
                output += `<span class="success-text">C++ WebAssembly:</span> <span class="number-text">${wasmTime.toFixed(2)}ms</span>\n`;
                output += `<span class="success-text">JavaScript:</span> <span class="number-text">${jsTime.toFixed(2)}ms</span>\n\n`;

                const speedup = jsTime / wasmTime;
                if (speedup > 1) {
                    output += `<span class="success-text">✓ Wasm이 ${speedup.toFixed(2)}배 빠름</span>`;
                } else {
                    output += `<span class="info-text">JS가 ${(1/speedup).toFixed(2)}배 빠름 (작은 연산에서는 JS가 빠를 수 있음)</span>`;
                }

                resultEl.innerHTML = output;
            } catch (e) {
                resultEl.innerHTML = `<span class="error-text">✗ Error: ${e.message}</span>`;
            }
        }

        // 페이지 로드 시 모듈 초기화
        window.addEventListener('DOMContentLoaded', initModule);
    </script>
</body>
</html>
